<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ESPUI 2DOF Mock — Desired + Sent + Actual</title>
    <style>
        :root{
            --bg:#f4f7fb; --card:#fff; --muted:#657786;
            --turquoise:#1abc9c; --peterriver:#3498db; --wisteria:#8e44ad;
            --sunflower:#f1c40f; --pumpkin:#d35400; --emerald:#2ecc71;
            --wet:#2c3e50; --midnight:#34495e;
            font-family:Inter, Roboto, Arial, sans-serif;
        }
        body{background:var(--bg); margin:0; color:#222}
        header{background:linear-gradient(90deg,#1f8fbe33,#8aa7bf33); padding:16px 20px}
        header h1{margin:0;font-size:18px}
        .container{max-width:1100px;margin:18px auto;padding:10px}
        .tabs{display:flex;gap:8px;margin-bottom:12px}
        .tab{background:var(--card); padding:10px 14px;border-radius:8px;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.06)}
        .tab.active{outline:3px solid rgba(0,0,0,.04)}
        .panel{background:var(--card); padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,.06)}
        .row{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
        .col{flex:1;min-width:180px}
        label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
        .controls {display:flex;gap:12px;align-items:center}
        input[type=range]{width:100%}
        input[type=number]{width:90px;padding:6px;border-radius:6px;border:1px solid #ddd}
        button{padding:8px 12px;border-radius:8px;border:0;background:#2d8cff;color:#fff;cursor:pointer}
        button.alt{background:#ff6b6b}
        .smallbtn{padding:6px 8px;font-size:13px}
        .labelbox{background:#fafafa;border-radius:6px;padding:10px;border:1px solid #eee;min-width:80px;text-align:center}
        textarea.log{width:100%;height:160px;border-radius:8px;padding:10px;border:1px solid #ddd;resize:vertical;background:#04111f0a}
        .wifi-row input{width:calc(100% - 12px)}
        .statusline{display:flex;gap:12px;align-items:center}
        .badge{padding:6px 10px;border-radius:999px;background:#eef5ff;color:#134; font-weight:600}
        footer{font-size:12px;color:#667;margin-top:10px;text-align:center}
        .muted{color:var(--muted);font-size:13px}
        .pid-panel{border-radius:8px;padding:10px;border:1px dashed #e6e6e6;background:#fafcff}
        .pid-row{display:flex;gap:12px;align-items:center;margin-bottom:8px}
        .pid-label{width:70px;font-weight:700}
        .tiny{font-size:12px;color:var(--muted)}
        .toggle{display:inline-flex;align-items:center;gap:8px}
        .chip{padding:6px 8px;border-radius:999px;background:#eef6ea;color:#1a5a2a}
        .graph-wrap{display:flex;gap:12px;align-items:flex-start}
        .graph-card{flex:1;min-width:360px;background:#fff;border-radius:8px;padding:12px;border:1px solid #eee}
        canvas{width:100%;height:240px;border-radius:6px;background:#fafafa}
        .graph-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
        .legend{display:flex;gap:12px;align-items:center}
        .legend-item{display:flex;gap:6px;align-items:center;font-size:13px}
        .swatch{width:12px;height:8px;border-radius:2px}
        .inline{display:inline-flex;align-items:center;gap:8px}
    </style>
</head>
<body>
<header><div class="container"><h1>ESPUI 2DOF Mock — Desired + Sent + Actual</h1></div></header>

<div class="container">
    <div class="tabs">
        <div class="tab active" data-tab="main">Main Control</div>
        <div class="tab" data-tab="login">Internet / Login</div>
        <div class="tab" data-tab="advanced">Advanced</div>
    </div>

    <!-- MAIN -->
    <div id="main" class="panel">
        <h3 style="margin-top:0">2DOF Robot — Main Controls</h3>
        <p class="muted">Endringer på sliders oppdaterer kun <strong>Desired</strong>. Kun når du sender (manuelt eller auto) settes <strong>Sent</strong>, og plantet (Actual) følger <em>Sent</em>.</p>

        <div class="row">
            <div class="col">
                <label>Shoulder (deg)</label>
                <div class="controls">
                    <input id="sliderShoulder" type="range" min="-180" max="180" value="0" aria-label="Shoulder slider"/>
                    <input id="numShoulder" type="number" min="-180" max="180" value="0" aria-label="Shoulder number"/>
                </div>
                <div class="tiny">Desired: <span id="desiredShoulder">0</span> — Sent: <span id="sentShoulder">0</span></div>
            </div>
            <div class="col">
                <label>Wrist (deg)</label>
                <div class="controls">
                    <input id="sliderWrist" type="range" min="-180" max="180" value="0" aria-label="Wrist slider"/>
                    <input id="numWrist" type="number" min="-180" max="180" value="0" aria-label="Wrist number"/>
                </div>
                <div class="tiny">Desired: <span id="desiredWrist">0</span> — Sent: <span id="sentWrist">0</span></div>
            </div>
        </div>

        <div class="row">
            <button id="btnHome">Home (0°)</button>
            <button id="btnStop" class="alt">Stop</button>

            <div style="flex:1"></div>

            <div class="inline">
                <label class="tiny" for="autoSendToggle">Auto-send on change</label>
                <input id="autoSendToggle" type="checkbox" checked />
            </div>

            <button id="btnSend" class="smallbtn">Send Command (simulate)</button>
            <button id="btnInjectFB" class="smallbtn">Inject Feedback (simulate A, ...)</button>
        </div>

        <!-- PID panel -->
        <div style="margin-top:12px" class="pid-panel">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <div style="flex:1">
                    <div style="font-weight:700">PID Controller</div>
                    <div class="tiny">Set controller gains. Changes send simulated PID message to Event Log.</div>
                </div>
                <div class="toggle">
                    <label class="tiny">Enabled</label>
                    <input id="pidEnabled" type="checkbox" checked />
                </div>
                <div class="chip tiny" id="pidModeChip">Mode: Position</div>
            </div>

            <div class="pid-row">
                <div class="pid-label">Kp</div>
                <div style="flex:1"><input id="sliderKp" type="range" min="0" max="100" value="10" /></div>
                <input id="numKp" type="number" step="0.01" min="0" max="10" value="1.00" />
            </div>
            <div class="pid-row">
                <div class="pid-label">Ki</div>
                <div style="flex:1"><input id="sliderKi" type="range" min="0" max="5000" value="0" /></div>
                <input id="numKi" type="number" step="0.001" min="0" max="5" value="0.000" />
            </div>
            <div class="pid-row">
                <div class="pid-label">Kd</div>
                <div style="flex:1"><input id="sliderKd" type="range" min="0" max="1000" value="0" /></div>
                <input id="numKd" type="number" step="0.001" min="0" max="1" value="0.000" />
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <button id="btnSendPID" class="smallbtn">Send PID (simulate)</button>
                <div class="tiny muted">Last sent:</div>
                <div class="tiny" id="lastPidSent">none</div>
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login" class="panel" style="display:none">
        <h3 style="margin-top:0">WiFi / Login</h3>
        <p class="muted">Provide WiFi credentials (mock). Click Apply to simulate saving.</p>
        <div class="row wifi-row">
            <div class="col"><label>SSID</label><input id="ssid" type="text" placeholder="SSID" /></div>
            <div class="col"><label>Password</label><input id="pass" type="password" placeholder="Password" /></div>
        </div>
        <div class="row"><button id="btnApply">Apply Settings</button><div class="muted">Current mode: <span id="wifiMode">STA (simulated)</span></div></div>
    </div>

    <!-- ADVANCED -->
    <div id="advanced" class="panel" style="display:none">
        <h3 style="margin-top:0">Status / Advanced</h3>
        <p class="muted"><strong>Live Feedback</strong> — Actual angles, status, and an event log (mock).</p>

        <div class="row statusline">
            <div class="labelbox"><div class="muted">System</div><div style="font-weight:700">OK</div></div>
            <div class="labelbox"><div class="muted">Shoulder Actual</div><div id="lblShoulderActual">0</div></div>
            <div class="labelbox"><div class="muted">Wrist Actual</div><div id="lblWristActual">0</div></div>
            <div style="flex:1"></div>
            <div style="text-align:right"><div class="muted">IP (simulated)</div><div class="badge" id="simIP">192.168.4.1</div></div>
        </div>

        <div class="graph-wrap" style="margin-top:12px">
            <div class="graph-card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="font-weight:700">Joint angles (live)</div>
                    <div class="legend">
                        <div class="legend-item"><div class="swatch" style="background:#e74c3c"></div><div class="tiny">Actual Shoulder</div></div>
                        <div class="legend-item"><div class="swatch" style="background:#3498db"></div><div class="tiny">Actual Wrist</div></div>
                        <div class="legend-item"><div class="swatch" style="background:#888" ></div><div class="tiny">Desired (dashed)</div></div>
                    </div>
                </div>
                <canvas id="plotCanvas" width="900" height="260"></canvas>
                <div class="graph-controls">
                    <button id="btnClearGraph" class="smallbtn">Clear</button>
                    <button id="btnToggleSim" class="smallbtn">Pause Sim</button>
                    <div class="tiny muted">Window:</div>
                    <select id="timeWindow"><option value="10">10 s</option><option value="20" selected>20 s</option><option value="60">60 s</option></select>
                </div>
            </div>

            <div style="width:320px"><label>Event Log</label><textarea id="log" class="log">Ready.</textarea></div>
        </div>

    </div>

    <footer>Local mock UI — no ESP required. Save as espui_2dof_mock_desired.html and open in browser.</footer>
</div>

<script>
    /* ------------------------
       Desired + Sent + Actual mock
       - desired: UI value
       - sent: last sent to device (plant target)
       - actual: plant state follows 'sent'
       - data.desired tracked and plotted as dashed line
       ------------------------ */

    /* Elements */
    const sliderShoulder = document.getElementById('sliderShoulder');
    const numShoulder = document.getElementById('numShoulder');
    const sliderWrist = document.getElementById('sliderWrist');
    const numWrist = document.getElementById('numWrist');
    const lblShoulderActual = document.getElementById('lblShoulderActual');
    const lblWristActual = document.getElementById('lblWristActual');
    const desiredShoulderEl = document.getElementById('desiredShoulder');
    const desiredWristEl = document.getElementById('desiredWrist');
    const sentShoulderEl = document.getElementById('sentShoulder');
    const sentWristEl = document.getElementById('sentWrist');
    const log = document.getElementById('log');

    const pidEnabled = document.getElementById('pidEnabled');
    const sliderKp = document.getElementById('sliderKp');
    const numKp = document.getElementById('numKp');
    const sliderKi = document.getElementById('sliderKi');
    const numKi = document.getElementById('numKi');
    const sliderKd = document.getElementById('sliderKd');
    const numKd = document.getElementById('numKd');
    const lastPidSent = document.getElementById('lastPidSent');

    const btnSend = document.getElementById('btnSend');
    const btnSendPID = document.getElementById('btnSendPID');
    const btnInjectFB = document.getElementById('btnInjectFB');
    const btnHome = document.getElementById('btnHome');
    const btnStop = document.getElementById('btnStop');

    const autoSendToggle = document.getElementById('autoSendToggle');

    const plotCanvas = document.getElementById('plotCanvas');
    const ctx = plotCanvas.getContext('2d');
    const btnClearGraph = document.getElementById('btnClearGraph');
    const btnToggleSim = document.getElementById('btnToggleSim');
    const timeWindowSelect = document.getElementById('timeWindow');

    /* State */
    let desired = { wrist: 0, shoulder: 0 };
    let sent = { wrist: 0, shoulder: 0 };
    let actual = { wrist: 0, shoulder: 0 };

    /* Plant params */
    let simParams = { tau: 0.3, dt: 0.05, noiseStd: 0.2 };

    /* Data buffers: actual + desired (for plotting) */
    let data = { shoulder: [], wrist: [], desiredShoulder: [], desiredWrist: [] };
    let startTime = performance.now()/1000;

    /* Logging helper */
    function appendLog(line){
        const now = new Date().toLocaleTimeString();
        if(log.value === 'Ready.') log.value = '';
        log.value += `[${now}] ${line}\n`;
        log.scrollTop = log.scrollHeight;
    }

    /* Update desired/sent UI */
    function updateDesiredSentUI(){
        desiredShoulderEl.textContent = desired.shoulder;
        desiredWristEl.textContent = desired.wrist;
        sentShoulderEl.textContent = sent.shoulder;
        sentWristEl.textContent = sent.wrist;
    }

    /* Slider <-> number sync updates desired only */
    function setDesiredShoulder(v, origin){
        v = Math.max(-180, Math.min(180, Number(v) || 0));
        desired.shoulder = v;
        if(origin !== 'slider') sliderShoulder.value = v;
        if(origin !== 'num') numShoulder.value = v;
        updateDesiredSentUI();
        scheduleAutoSendForPosition();
    }
    function setDesiredWrist(v, origin){
        v = Math.max(-180, Math.min(180, Number(v) || 0));
        desired.wrist = v;
        if(origin !== 'slider') sliderWrist.value = v;
        if(origin !== 'num') numWrist.value = v;
        updateDesiredSentUI();
        scheduleAutoSendForPosition();
    }
    sliderShoulder.addEventListener('input', e => setDesiredShoulder(e.target.value, 'slider'));
    numShoulder.addEventListener('change', e => setDesiredShoulder(e.target.value, 'num'));
    sliderWrist.addEventListener('input', e => setDesiredWrist(e.target.value, 'slider'));
    numWrist.addEventListener('change', e => setDesiredWrist(e.target.value, 'num'));

    /* PID slider-number sync (unchanged) */
    function updateNumFromSlider(slider, num, scaleFn){
        slider.addEventListener('input', ()=>{ num.value = scaleFn(slider.value); schedulePidAutoSend(); });
    }
    function updateSliderFromNum(slider, num, invScaleFn){
        num.addEventListener('change', ()=>{ slider.value = invScaleFn(num.value); schedulePidAutoSend(); });
    }
    updateNumFromSlider(sliderKp, numKp, v => (v/10).toFixed(2));
    updateSliderFromNum(sliderKp, numKp, v => Math.round(Number(v)*10));
    updateNumFromSlider(sliderKi, numKi, v => (v/1000).toFixed(3));
    updateSliderFromNum(sliderKi, numKi, v => Math.round(Number(v)*1000));
    updateNumFromSlider(sliderKd, numKd, v => (v/1000).toFixed(3));
    updateSliderFromNum(sliderKd, numKd, v => Math.round(Number(v)*1000));
    pidEnabled.addEventListener('change', ()=> schedulePidAutoSend());
    function readPidValues(){ return { enabled: pidEnabled.checked?1:0, Kp: Number(numKp.value), Ki: Number(numKi.value), Kd: Number(numKd.value) }; }

    /* Auto-send: scheduled debounced send from desired -> sent */
    let autoSend = autoSendToggle.checked;
    let sendTimer = null;
    const DEBOUNCE_MS = 150;
    autoSendToggle.addEventListener('change', ()=>{
        autoSend = autoSendToggle.checked;
        appendLog(`Auto-send ${autoSend ? 'enabled' : 'disabled'}`);
        if(!autoSend && sendTimer){ clearTimeout(sendTimer); sendTimer = null; }
    });

    function scheduleAutoSendForPosition(){
        if(!autoSend) return;
        if(sendTimer) clearTimeout(sendTimer);
        const snap = { wrist: desired.wrist, shoulder: desired.shoulder };
        sendTimer = setTimeout(()=>{
            if(autoSend) sendPosition(false, snap);
            sendTimer = null;
        }, DEBOUNCE_MS);
    }

    /* sendPosition: update sent from desired (or snapshot) and log */
    function sendPosition(force=false, snapshot=null){
        if(!force && !autoSend) return;
        const s = snapshot ? { wrist: snapshot.wrist, shoulder: snapshot.shoulder } : { wrist: desired.wrist, shoulder: desired.shoulder };
        sent.wrist = s.wrist; sent.shoulder = s.shoulder;
        updateDesiredSentUI();
        appendLog(`SEND -> P,${sent.wrist},${sent.shoulder}`);
    }

    /* PID send */
    let pidTimer = null;
    function schedulePidAutoSend(){ if(pidTimer) clearTimeout(pidTimer); pidTimer = setTimeout(()=>{ sendPid(); pidTimer=null; }, 200); }
    function sendPid(){ const p = readPidValues(); const msg = `PID,${p.enabled},${p.Kp.toFixed(3)},${p.Ki.toFixed(3)},${p.Kd.toFixed(3)}`; appendLog('SEND -> ' + msg); lastPidSent.textContent = msg; }

    /* Buttons */
    btnSend.addEventListener('click', ()=> sendPosition(true));
    btnSendPID.addEventListener('click', ()=> sendPid());
    btnInjectFB.addEventListener('click', ()=>{
        actual.wrist = sent.wrist; actual.shoulder = sent.shoulder;
        appendLog(`RCV <- A,${actual.wrist.toFixed(2)},${actual.shoulder.toFixed(2)}`);
        updateActualLabels();
        pushDataPoint();
    });
    btnHome.addEventListener('click', ()=>{
        desired.wrist = 0; desired.shoulder = 0;
        sliderWrist.value = 0; sliderShoulder.value = 0; numWrist.value = 0; numShoulder.value = 0;
        updateDesiredSentUI(); scheduleAutoSendForPosition(); appendLog('Home requested (desired set to 0)');
    });
    btnStop.addEventListener('click', ()=>{
        sent.wrist = actual.wrist; sent.shoulder = actual.shoulder; updateDesiredSentUI(); appendLog('Stop requested — sent target set to current actual');
    });

    /* Plotting */
    const W = plotCanvas.width;
    const H = plotCanvas.height;
    const padding = {left:48, right:12, top:12, bottom:28};
    const plotHeight = H - padding.top - padding.bottom;
    const plotWidth = W - padding.left - padding.right;

    function clearData(){ data.shoulder=[]; data.wrist=[]; data.desiredShoulder=[]; data.desiredWrist=[]; startTime = performance.now()/1000; }
    btnClearGraph.addEventListener('click', ()=>{ clearData(); drawPlot(); appendLog('Graph cleared'); });
    btnToggleSim.addEventListener('click', ()=>{ simRunning = !simRunning; btnToggleSim.textContent = simRunning ? 'Pause Sim' : 'Resume Sim'; });

    function tToX(t, now, windowSec){ const rel = now - t; return W - padding.right - (rel / windowSec) * plotWidth; }

    function drawPlot(){
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,W,H);
        const windowSec = Number(timeWindowSelect.value);
        // grid
        ctx.strokeStyle = '#e6e6e6'; ctx.lineWidth = 1; ctx.beginPath();
        for(let y=-180;y<=180;y+=60){ const yy = valueToY(y); ctx.moveTo(padding.left, yy); ctx.lineTo(W-padding.right, yy); }
        ctx.stroke();
        // left labels
        ctx.fillStyle = '#444'; ctx.font = '12px Arial'; ctx.textAlign = 'right';
        for(let y=-180;y<=180;y+=60){ const yy = valueToY(y); ctx.fillText(y+'°', padding.left-8, yy+4); }
        // time ticks
        ctx.textAlign = 'center'; ctx.fillStyle = '#666';
        const now = performance.now()/1000; const ticks=6;
        for(let i=0;i<=ticks;i++){ const sAgo = (i/ticks)*windowSec; const t = now - sAgo; const x = tToX(t, now, windowSec); ctx.fillText((-Math.round(sAgo))+'s', x, H-6); }

        ctx.save(); ctx.beginPath(); ctx.rect(padding.left, padding.top, plotWidth, plotHeight); ctx.clip();

        // draw desired (dashed gray)
        drawLineFromData(data.desiredShoulder, '#888', now, windowSec, {dash:true});
        drawLineFromData(data.desiredWrist, '#bbb', now, windowSec, {dash:true});

        // draw actual (solid)
        drawLineFromData(data.shoulder, '#e74c3c', now, windowSec, {dash:false});
        drawLineFromData(data.wrist, '#3498db', now, windowSec, {dash:false});

        // optionally: we could draw sent as vertical markers — kept as text in UI
        ctx.restore();
    }

    function drawLineFromData(points, color, now, windowSec, opts={dash:false}){
        if(points.length === 0) return;
        ctx.lineWidth = opts.dash ? 1.2 : 2;
        ctx.strokeStyle = color;
        if(opts.dash) ctx.setLineDash([6,6]); else ctx.setLineDash([]);
        ctx.beginPath();
        let started = false;
        for(let i=0;i<points.length;i++){
            const p = points[i];
            if(now - p.t > windowSec) continue;
            const x = tToX(p.t, now, windowSec);
            const y = valueToY(p.v);
            if(!started){ ctx.moveTo(x,y); started = true; } else ctx.lineTo(x,y);
        }
        ctx.stroke();
        ctx.setLineDash([]);
    }

    function valueToY(v){ const vc = Math.max(-180, Math.min(180, Number(v))); const top=padding.top; const bottom=H-padding.bottom; return bottom - ((vc+180)/360)*(bottom-top); }

    function pushDataPoint(){
        const now = performance.now()/1000;
        data.shoulder.push({t: now, v: actual.shoulder});
        data.wrist.push({t: now, v: actual.wrist});
        // also record desired values for plotting
        data.desiredShoulder.push({t: now, v: desired.shoulder});
        data.desiredWrist.push({t: now, v: desired.wrist});
        const maxKeep = 120;
        data.shoulder = data.shoulder.filter(pt => now - pt.t <= maxKeep);
        data.wrist = data.wrist.filter(pt => now - pt.t <= maxKeep);
        data.desiredShoulder = data.desiredShoulder.filter(pt => now - pt.t <= maxKeep);
        data.desiredWrist = data.desiredWrist.filter(pt => now - pt.t <= maxKeep);
    }

    function updateActualLabels(){ lblShoulderActual.textContent = actual.shoulder.toFixed(2); lblWristActual.textContent = actual.wrist.toFixed(2); }

    /* Simulation: actual moves toward SENT target only */
    let simRunning = true;
    let lastSim = performance.now();
    function simStep(){
        const now = performance.now();
        let elapsed = (now - lastSim)/1000; lastSim = now;
        const step = simParams.dt;
        while(elapsed > 1e-9){
            const d = Math.min(step, elapsed);
            if(simRunning){
                const tau = simParams.tau;
                actual.shoulder += (sent.shoulder - actual.shoulder) * (d / (tau + 1e-9));
                actual.wrist += (sent.wrist - actual.wrist) * (d / (tau + 1e-9));
                actual.shoulder += (Math.random()*2-1)*simParams.noiseStd*0.01;
                actual.wrist += (Math.random()*2-1)*simParams.noiseStd*0.01;
            }
            elapsed -= d;
        }
        // sample at ~20Hz
        if(performance.now() % 50 < 20){
            updateActualLabels();
            pushDataPoint();
        }
    }

    function loopAnim(){ simStep(); drawPlot(); requestAnimationFrame(loopAnim); }

    /* init */
    clearData(); pushDataPoint(); updateActualLabels(); updateDesiredSentUI(); appendLog('Mock started — desired (dashed) shown; plant follows SENT'); requestAnimationFrame(loopAnim);

    /* Tabs */
    document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
        const name = t.dataset.tab; ['main','login','advanced'].forEach(n=> document.getElementById(n).style.display = (n===name)?'block':'none');
    }));

    /* Ctrl/Cmd+S: save log */
    window.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); const blob=new Blob([log.value],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='espui_mock_log.txt'; a.click(); URL.revokeObjectURL(a.href); } });
</script>
</body>
</html>
